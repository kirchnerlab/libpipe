#!/bin/bash

prev=`pwd`

cd @LIBPIPE_BINARY_DIR@

lcov --directory @LIBPIPE_BINARY_DIR@ --zerocounters
find @LIBPIPE_BINARY_DIR@ -name *.gcda -print0 | xargs -0 rm -f

make test_$1

mkdir -p @LIBPIPE_BINARY_DIR@/test/coverage_$1
rm -rf @LIBPIPE_BINARY_DIR@/test/coverage_$1/*

cd @LIBPIPE_BINARY_DIR@/test
echo "### RUNNING TEST ###"
./test_$1
echo "### ...     DONE ###"
lcov --directory @LIBPIPE_BINARY_DIR@/test/CMakeFiles \
     --directory @LIBPIPE_BINARY_DIR@/src/CMakeFiles/pipe.dir \
     -capture --output-file @LIBPIPE_BINARY_DIR@/test/coverage_$1/$1.info
lcov --extract @LIBPIPE_BINARY_DIR@/test/coverage_$1/$1.info '*libpipe/src*' '*libpipe/include/libpipe*' -o @LIBPIPE_BINARY_DIR@/test/coverage_$1/$1x.info
cd @LIBPIPE_BINARY_DIR@/test/coverage_$1
genhtml $1x.info

cd $prev
